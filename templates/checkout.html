{% extends 'base.html' %}
{% load static %}

{% block title %}Complete Your Reservation{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Complete Your Reservation</h1>
    <div class="row">
        <!-- Left Column: Checkout Form -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-4">Complete Your Reservation</h4>
                    <form id="checkout-form" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="caravan_id" value="{{ caravan.id }}">

                        <!-- Start and End Date Selection -->
                        <div class="row g-3 mb-3">
                            <div class="col">
                                <label for="start_date_input" class="form-label">Start Date</label>
                                <input type="date" id="start_date_input" name="start_date" class="form-control" required>
                            </div>
                            <div class="col">
                                <label for="end_date_input" class="form-label">End Date</label>
                                <input type="date" id="end_date_input" name="end_date" class="form-control" required>
                            </div>
                        </div>

                        <!-- Payment Method Selection -->
                        <h5 class="mb-3">Payment Method</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="credit_card" checked>
                            <label class="form-check-label" for="credit_card">
                                Credit Card
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="paypal" value="paypal">
                            <label class="form-check-label" for="paypal">
                                PayPal
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="toss" value="toss">
                            <label class="form-check-label" for="toss">
                                Toss
                            </label>
                        </div>

                        <hr class="my-4">

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">Confirm & Pay</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Caravan Summary -->
        <div class="col-lg-5">
            <div class="position-sticky" style="top: 2rem;">
                <div class="card shadow-sm">
                    {% if caravan.images.first %}
                        <img src="{{ caravan.images.first.image.url }}" class="card-img-top" alt="{{ caravan.name }}">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ caravan.name }}</h5>
                        <p class="card-text text-muted">{{ caravan.location }}</p>
                        <hr>
                        <p class="text-muted">Please select your dates and proceed to confirm the total price.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.tosspayments.com/v1"></script>
<script>
    const checkoutForm = document.getElementById('checkout-form');
    checkoutForm.addEventListener('submit', function (event) {
        const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        if (selectedPaymentMethod === 'toss') {
            event.preventDefault();

            const tossPayments = TossPayments('{{ TOSS_PAYMENTS_CLIENT_KEY }}');
            const startDate = document.getElementById('start_date_input').value;
            const endDate = document.getElementById('end_date_input').value;
            const caravanId = document.querySelector('input[name="caravan_id"]').value;

            // You will need to calculate the amount on the server-side and pass it to the template
            // For now, let's use a placeholder amount
            const amount = 1000; 

            tossPayments.requestPayment('카드', {
                amount: amount,
                orderId: 'order__' + new Date().getTime(), // Replace with a unique order ID
                orderName: '{{ caravan.name }}',
                customerName: '{{ request.user.username }}',
                successUrl: window.location.origin + '{% url "toss_success" %}',
                failUrl: window.location.origin + '{% url "toss_fail" %}',
            });
        }
    });
</script>
{% endblock %}
